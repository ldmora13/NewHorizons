---
/*
 * Destination page after a successful PayPal checkout.
 * Transaction data is read from sessionStorage (key: "nh_tx_success"),
 * consumed once, and then deleted — it never travels through the URL.
 *
 * If the key is absent (direct navigation / refresh) the page shows a
 * generic confirmation with a link back to the home page.
 */
import Layout from "../layouts/MainLayout.astro";
---

<Layout title="Payment Successful — New Horizons">
  <section class="relative min-h-screen py-16 md:py-24">
    <div class="max-w-3xl mx-auto px-4">

      <!-- ── SKELETON shown while JS runs ─────────────────────────── -->
      <div id="ps-loading" class="text-center py-32 text-white/40 text-sm animate-pulse">
        Loading your receipt…
      </div>

      <!-- ── SUCCESS CARD (populated by JS) ────────────────────────── -->
      <div id="ps-card" class="hidden rounded-3xl bg-white/5 border border-white/10 backdrop-blur p-10 space-y-8">

        <!-- Header -->
        <div class="text-center space-y-4">
          <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none"
                 viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <h1 class="text-4xl font-bold text-white" data-i18n="checkout.paymentSuccessful">
            Transaction Approved!
          </h1>
          <p class="text-lg text-white/70" data-i18n="checkout.thankYouMessage">
            Thank you for choosing New Horizons. Your process for France has officially started.
          </p>
        </div>

        <!-- File Reference -->
        <div class="bg-black/30 rounded-2xl border border-white/10 p-6 text-center">
          <p class="text-white/50 text-sm mb-1" data-i18n="checkout.orderNumber">File Reference</p>
          <p id="ps-ticket-id" class="text-3xl font-mono text-blue-400 font-bold tracking-widest"></p>
        </div>

        <!-- Transaction Details Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

          <div class="rounded-2xl bg-white/5 border border-white/10 p-5 space-y-1">
            <p class="text-white/40 text-xs uppercase tracking-wider">Program</p>
            <p id="ps-program" class="text-white font-semibold text-sm"></p>
          </div>

          <div class="rounded-2xl bg-white/5 border border-white/10 p-5 space-y-1">
            <p class="text-white/40 text-xs uppercase tracking-wider">Destination</p>
            <p id="ps-destination" class="text-white font-semibold text-sm">France</p>
          </div>

          <div class="rounded-2xl bg-white/5 border border-white/10 p-5 space-y-1">
            <p class="text-white/40 text-xs uppercase tracking-wider">Family Members</p>
            <p id="ps-family" class="text-white font-semibold text-sm"></p>
          </div>

          <div class="rounded-2xl bg-white/5 border border-white/10 p-5 space-y-1">
            <p class="text-white/40 text-xs uppercase tracking-wider">Payment Method</p>
            <p id="ps-method" class="text-white font-semibold text-sm">PayPal</p>
          </div>

          <div class="rounded-2xl bg-white/5 border border-white/10 p-5 space-y-1">
            <p class="text-white/40 text-xs uppercase tracking-wider">Date</p>
            <p id="ps-date" class="text-white font-semibold text-sm"></p>
          </div>

          <div class="rounded-2xl bg-white/5 border border-white/10 p-5 space-y-1">
            <p class="text-white/40 text-xs uppercase tracking-wider">Amount Paid</p>
            <p id="ps-amount" class="text-blue-400 font-bold text-lg"></p>
          </div>

        </div>

        <!-- Account Info (new users only) -->
        <div id="ps-account-block" class="hidden rounded-2xl bg-blue-500/10 border border-blue-500/20 p-6 space-y-3">
          <div class="flex items-center gap-2 text-blue-300 font-semibold">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
            <span>Your portal account has been created</span>
          </div>
          <div class="space-y-1 text-sm">
            <p class="text-white/60">
              Email: <span id="ps-email" class="text-white font-medium"></span>
            </p>
            <p class="text-white/60">
              Temporary password: <span id="ps-temp-pass" class="text-white font-mono font-medium bg-black/30 px-2 py-0.5 rounded"></span>
            </p>
          </div>
          <p class="text-white/40 text-xs">
            Please log in and change your password at your earliest convenience.
          </p>
        </div>

        <!-- Returning-user confirmation -->
        <div id="ps-returning-block" class="hidden text-center">
          <p class="text-white/60 text-sm" id="ps-returning-msg"></p>
        </div>

        <!-- CTA -->
        <div class="flex flex-col sm:flex-row gap-4 pt-2">
          <a href="/"
             class="flex-1 text-center rounded-xl bg-white px-6 py-4 font-bold text-black hover:bg-white/90 hover:scale-[1.02] transition active:scale-95"
             data-i18n="common.returnToHome">
            Return to Home
          </a>
          <a href="http://localhost:5173/login"
             class="flex-1 text-center rounded-xl bg-blue-500/20 border border-blue-500/30 px-6 py-4 font-semibold text-blue-300 hover:bg-blue-500/30 hover:scale-[1.02] transition active:scale-95">
            Go to My Portal →
          </a>
        </div>

      </div>

      <!-- ── FALLBACK (direct navigation / missing data) ────────────── -->
      <div id="ps-fallback" class="hidden text-center py-20 space-y-6 rounded-3xl bg-white/5 border border-white/10 backdrop-blur p-10">
        <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
          </svg>
        </div>
        <h2 class="text-3xl font-bold text-white">Payment Confirmed</h2>
        <p class="text-white/60">Your immigration process has started. Check your email for details.</p>
        <a href="/"
           class="inline-block rounded-xl bg-white px-8 py-3 font-semibold text-black hover:bg-white/90 transition">
          Return to Home
        </a>
      </div>

    </div>
  </section>
</Layout>

<script>
  (() => {
    const loading    = document.getElementById('ps-loading')!;
    const card       = document.getElementById('ps-card')!;
    const fallback   = document.getElementById('ps-fallback')!;

    // ── helpers ───────────────────────────────────────────────────────
    function show(el: HTMLElement) { el.classList.remove('hidden'); }
    function hide(el: HTMLElement) { el.classList.add('hidden'); }
    function setText(id: string, value: string) {
      const el = document.getElementById(id);
      if (el) el.textContent = value;
    }

    function formatCurrency(amount: number): string {
      // Reuse the same i18n helper if available, otherwise fallback
      if ((window as any).i18n?.formatCurrency) {
        return (window as any).i18n.formatCurrency(amount);
      }
      return `$${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function formatDate(iso: string): string {
      try {
        return new Date(iso).toLocaleString('en-US', {
          year: 'numeric', month: 'long', day: 'numeric',
          hour: '2-digit', minute: '2-digit'
        });
      } catch {
        return iso;
      }
    }

    // ── read & consume sessionStorage key ────────────────────────────
    const raw = sessionStorage.getItem('nh_tx_success');
    hide(loading);

    if (!raw) {
      // No data: direct nav or page refresh after first render
      show(fallback);
      return;
    }

    // Consume immediately — prevents stale data on future visits
    sessionStorage.removeItem('nh_tx_success');

    let tx: Record<string, any>;
    try {
      tx = JSON.parse(raw);
    } catch {
      show(fallback);
      return;
    }

    // ── populate card ─────────────────────────────────────────────────
    setText('ps-ticket-id',   tx.ticketId ? `EXP-${tx.ticketId}` : tx.paypalOrderId ?? '—');
    setText('ps-program',     `${tx.programId} — ${tx.programLabel}`);
    setText('ps-destination', tx.destination ?? 'France');
    setText('ps-family',      `${tx.adults ?? 1} Adult${(tx.adults ?? 1) !== 1 ? 's' : ''}, ${tx.children ?? 0} Child${(tx.children ?? 0) !== 1 ? 'ren' : ''}`);
    setText('ps-method',      tx.paymentMethod ?? 'PayPal');
    setText('ps-date',        formatDate(tx.paymentDate));
    setText('ps-amount',      formatCurrency(tx.amountPaid ?? 0));

    if (tx.isNewUser && tx.tempPassword) {
      const accountBlock = document.getElementById('ps-account-block')!;
      show(accountBlock);
      setText('ps-email',     tx.userEmail ?? '');
      setText('ps-temp-pass', tx.tempPassword);
    } else {
      const returningBlock = document.getElementById('ps-returning-block')!;
      show(returningBlock);
      setText('ps-returning-msg', `A confirmation email has been sent to ${tx.userEmail ?? 'your inbox'}.`);
    }

    hide(loading);
    show(card);

    // Scroll to top cleanly
    window.scrollTo({ top: 0, behavior: 'instant' });
  })();
</script>

<style>
  /* Preserve the same backdrop-blur / glassmorphism feel as CheckoutForm */
  section {
    background: radial-gradient(ellipse at 60% 0%, rgba(59,130,246,0.08) 0%, transparent 70%);
  }
</style>