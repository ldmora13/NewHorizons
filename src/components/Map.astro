<section class="map__section">
	<div class="map__background">
		<div class="stars"></div>
		<div class="clouds"></div>
	</div>
	
	<div class="map__container">
		<svg
			id="flight-map"
			viewBox="0 180 1000 500"
			class="map-svg"
			preserveAspectRatio="xMidYMid slice"
		>
			<defs>
				<!-- Gradientes para efectos visuales -->
				<linearGradient id="pathGradient" x1="0%" y1="0%" x2="100%" y2="0%">
					<stop offset="0%" style="stop-color:#3b82f6;stop-opacity:0.8" />
					<stop offset="50%" style="stop-color:#8b5cf6;stop-opacity:0.8" />
					<stop offset="100%" style="stop-color:#ec4899;stop-opacity:0.8" />
				</linearGradient>
				
				<!-- Filtro de brillo para el avión -->
				<filter id="glow">
					<feGaussianBlur stdDeviation="3" result="coloredBlur"/>
					<feMerge>
						<feMergeNode in="coloredBlur"/>
						<feMergeNode in="SourceGraphic"/>
					</feMerge>
				</filter>
				
				<!-- Filtro para sombras suaves -->
				<filter id="softShadow" x="-50%" y="-50%" width="200%" height="200%">
					<feGaussianBlur in="SourceAlpha" stdDeviation="4"/>
					<feOffset dx="0" dy="4" result="offsetblur"/>
					<feComponentTransfer>
						<feFuncA type="linear" slope="0.5"/>
					</feComponentTransfer>
					<feMerge> 
						<feMergeNode/>
						<feMergeNode in="SourceGraphic"/>
					</feMerge>
				</filter>
			</defs>
			
			<g id="map-world">
				<!-- MAPA -->
				<image
					href="/img/map/map.svg"
					width="1000"
					height="1000"
				/>

				<!-- RUTA USA → EUROPA (Ahora visible con gradiente) -->
				<path
					id="flight-path"
					d="M220 480 C320 300, 400 300, 500 440"
					fill="none"
					stroke="url(#pathGradient)"
					stroke-width="3"
					stroke-dasharray="10 5"
					opacity="0"
				/>
				
				<!-- Partículas de estela del avión -->
				<g id="plane-trail">
					<circle class="trail-particle" cx="0" cy="0" r="2" fill="#60a5fa" opacity="0"/>
					<circle class="trail-particle" cx="0" cy="0" r="2" fill="#a78bfa" opacity="0"/>
					<circle class="trail-particle" cx="0" cy="0" r="2" fill="#f472b6" opacity="0"/>
				</g>

				<!-- AVIÓN con brillo -->
				<image
					id="plane"
					href="/img/map/plane.svg"
					width="40"
					height="40"
					x="0" 
					y="0"
					filter="url(#glow)"
				/>

				<!-- MARCADORES DE UBICACIÓN -->
				<g id="location-usa" opacity="0">
					<circle cx="220" cy="490" r="8" fill="#3b82f6" stroke="#ffffff" stroke-width="2"/>
					<circle cx="220" cy="490" r="10" fill="none" stroke="#3b82f6" stroke-width="2" opacity="0.5" class="pulse-ring"/>
				</g>
				
				<g id="location-europe" opacity="0">
					<circle cx="500" cy="450" r="8" fill="#ec4899" stroke="#ffffff" stroke-width="2"/>
					<circle cx="500" cy="450" r="10" fill="none" stroke="#ec4899" stroke-width="2" opacity="0.5" class="pulse-ring"/>
				</g>	

				<!-- TEXT -->
				<defs>
					<pattern id="usaFlagPattern" patternUnits="objectBoundingBox" width="1" height="1">
						<image href="/img/usa-flag.png" width="160" height="50" opacity="0.4" preserveAspectRatio="xMidYMid slice"/>
					</pattern>
				</defs>

				<g id="text-usa-group" opacity="0">
					<rect 
						x="140" 
						y="410" 
						width="160" 
						height="50" 
						rx="8" 
						fill="url(#usaFlagPattern)" 
						filter="url(#softShadow)"
					/>
					<text x="220" y="435" text-anchor="middle" class="map-text map-text-title">
						FROM
					</text>
					<text x="220" y="450" text-anchor="middle" class="map-text map-text-location">
						USA
					</text>
				</g>
				
				<g id="text-europe-group" opacity="0">
					<rect x="385" y="355" width="230" height="65" rx="8" fill="rgba(236, 72, 153, 0.95)" filter="url(#softShadow)"/>
					<text x="500" y="380" text-anchor="middle" class="map-text map-text-title">DESTINATION</text>
					<text x="500" y="400" text-anchor="middle" class="map-text map-text-dream">To Fulfill Your</text>
					<text x="500" y="415" text-anchor="middle" class="map-text map-text-dream-emphasis">Dreams</text>
				</g>
			</g>
		</svg>
	</div>
</section>

<style>
	.map__section {
		height: 100vh;
		display: flex;
		align-items: center;
		justify-content: center;
		position: relative;
		background: linear-gradient(180deg, #0f172a 0%, #1e293b 50%, #334155 100%);
		overflow: hidden;
	}
	
	.map__background {
		position: absolute;
		inset: 0;
		pointer-events: none;
	}
	
	/* Estrellas animadas */
	.stars {
		position: absolute;
		inset: 0;
		background-image: 
			radial-gradient(2px 2px at 20% 30%, white, transparent),
			radial-gradient(2px 2px at 60% 70%, white, transparent),
			radial-gradient(1px 1px at 50% 50%, white, transparent),
			radial-gradient(1px 1px at 80% 10%, white, transparent),
			radial-gradient(2px 2px at 90% 60%, white, transparent),
			radial-gradient(1px 1px at 33% 80%, white, transparent),
			radial-gradient(1px 1px at 15% 60%, white, transparent),
			radial-gradient(2px 2px at 10% 10%, white, transparent),
			radial-gradient(2px 2px at 40% 20%, white, transparent),
			radial-gradient(1px 1px at 70% 85%, white, transparent),
			radial-gradient(2px 2px at 85% 35%, white, transparent),
			radial-gradient(1px 1px at 5% 90%, white, transparent),
			radial-gradient(1px 1px at 25% 55%, white, transparent),
			radial-gradient(2px 2px at 95% 15%, white, transparent),
			radial-gradient(1px 1px at 45% 45%, white, transparent),
			radial-gradient(2px 2px at 65% 5%, white, transparent),
			radial-gradient(1px 1px at 12% 40%, white, transparent),
			radial-gradient(2px 2px at 55% 95%, white, transparent),
			radial-gradient(1px 1px at 75% 50%, white, transparent),
			radial-gradient(2px 2px at 30% 75%, white, transparent);
		background-size: 200% 200%;
		animation: twinkle 8s ease-in-out infinite;
		opacity: 0.8;
	}
	
	@keyframes twinkle {
		0%, 100% { opacity: 0.6; }
		50% { opacity: 0.9; }
	}
	
	/* Nubes sutiles */
	.clouds {
		position: absolute;
		inset: 0;
		background: 
			radial-gradient(ellipse at 30% 40%, rgba(148, 163, 184, 0.1) 0%, transparent 50%),
			radial-gradient(ellipse at 70% 60%, rgba(148, 163, 184, 0.08) 0%, transparent 50%);
		animation: cloudMove 20s ease-in-out infinite;
	}
	
	@keyframes cloudMove {
		0%, 100% { transform: translateX(0); }
		50% { transform: translateX(20px); }
	}

	.map__container {
		width: 100%;
		display: flex;
		justify-content: center;
		z-index: 1;
	}

	.map-svg {
		width: 95%;
		max-width: 1200px;
		will-change: transform;
		overflow: visible;
		filter: drop-shadow(0 10px 30px rgba(255, 255, 255, 0.755));
	}

	.map-text {
		font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
		fill: white;
		pointer-events: none;
		letter-spacing: 0.5px;
	}
	
	.map-text-title {
		font-size: 14px;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 2px;
		opacity: 0.9;
	}
	
	.map-text-location {
		font-size: 22px;
		font-weight: 900;
		text-transform: uppercase;
		letter-spacing: 1px;
	}
	
	.map-text-dream {
		font-size: 18px;
		font-weight: 600;
		font-style: italic;
	}
	
	.map-text-dream-emphasis {
		font-size: 24px;
		font-weight: 900;
		text-transform: uppercase;
		letter-spacing: 2px;
		fill: #fef08a;
		filter: drop-shadow(0 0 8px rgba(254, 240, 138, 0.8));
	}
	
	.map-text-main-title {
		font-size: 24px;
		font-weight: 800;
		text-transform: uppercase;
		letter-spacing: 2px;
		fill: white;
		text-shadow: 0 2px 4px rgba(0,0,0,0.5);
	}
	
	/* Animación de pulso para los marcadores */
	@keyframes pulse {
		0%, 100% {
			r: 15;
			opacity: 0.5;
		}
		50% {
			r: 20;
			opacity: 0;
		}
	}
	
	.pulse-ring {
		animation: pulse 2s ease-out infinite;
	}
	
	/* Responsive */
	@media (max-width: 768px) {
		.map-text-title {
			font-size: 12px;
		}
		.map-text-location {
			font-size: 18px;
		}
		.map-text-dream {
			font-size: 14px;
		}
		.map-text-dream-emphasis {
			font-size: 20px;
		}
	}
</style>

<script>
	import { gsap } from "gsap";
	import { ScrollTrigger } from "gsap/ScrollTrigger";
	import { MotionPathPlugin } from "gsap/MotionPathPlugin";

	gsap.registerPlugin(ScrollTrigger, MotionPathPlugin);

	const mm = gsap.matchMedia();

	mm.add("(min-width: 100px)", () => {
		const tl = gsap.timeline({
			scrollTrigger: {
				trigger: ".map__section",
				start: "top top",
				end: "+=500%", // Mayor duración para animaciones más suaves
				scrub: 1.5,
				pin: true,
				anticipatePin: 1
			}
		});

		// Configuración inicial del avión
		gsap.set("#plane", { 
			motionPath: {
				path: "#flight-path",
				align: "#flight-path",
				alignOrigin: [0.5, 0.5],
				start: 0,
				end: 0
			}
		});

		// Configuración inicial del Título
		gsap.set("#text-title-group", { 
			opacity: 1,
			y: 0
		});

		tl
		// === FASE 0: SALIDA TÍTULO ===
		.to("#text-title-group", {
			opacity: 0,
			y: 20,
			duration: 0.8,
			ease: "power2.in"
		})

		// === FASE 1: INTRO USA ===
		// Mostrar marcador USA con entrada elegante
		.to("#location-usa", { 
			opacity: 1, 
			scale: 1.2,
			duration: 0.8,
			ease: "back.out(1.7)"
		})
		.to("#location-usa", { 
			scale: 1,
			duration: 0.5
		})
		
		// Zoom suave hacia USA
		.to("#map-world", { 
			scale: 2.5, 
			transformOrigin: "220px 480px", 
			duration: 2,
			ease: "power2.inOut"
		}, "-=0.3")
		
		// Mostrar texto USA con animación de entrada
		.to("#text-usa-group", { 
			opacity: 1, 
			y: -10,
			duration: 1,
			ease: "power2.out"
		}, "-=0.8")
		
		// Pausa para lectura
		.to({}, { duration: 1.2 })
		
		// === FASE 2: TRANSICIÓN ===
		// Ocultar texto USA
		.to("#text-usa-group", { 
			opacity: 0, 
			y: 10,
			duration: 0.8,
			ease: "power2.in"
		})
		
		// Zoom out suave
		.to("#map-world", { 
			scale: 1, 
			x: 0, 
			y: 0,
			duration: 2.5,
			ease: "power2.inOut"
		}, "-=0.3")
		
		// === FASE 3: VUELO ===
		// Mostrar ruta con animación
		.to("#flight-path", {
			opacity: 0.6,
			duration: 1,
			ease: "power1.in"
		}, "-=1")
		
		// Animación del avión con estela
		.to("#plane", {
			motionPath: {
				path: "#flight-path",
				align: "#flight-path",
				alignOrigin: [0.5, 0.5],
			},
			duration: 4,
			ease: "power1.inOut",
			onUpdate: function() {
				// Animar partículas de estela
				const progress = this.progress();
				gsap.to(".trail-particle", {
					opacity: 0.3 + (progress * 0.5),
					scale: 1 + (progress * 0.5),
					stagger: 0.1,
					duration: 0.3
				});
			}
		}, "-=0.5")
		
		// Pulsar el avión durante el vuelo
		.to("#plane", {
			scale: 1.15,
			duration: 0.4,
			yoyo: true,
			repeat: 3,
			ease: "sine.inOut",
            rotate: 10
		}, "-=3")
		
		// === FASE 4: DESTINO EUROPA ===
		// Mostrar marcador Europa
		.to("#location-europe", { 
			opacity: 1,
			scale: 1.2,
			duration: 0.8,
			ease: "back.out(1.7)"
		}, "-=1.5")
		.to("#location-europe", { 
			scale: 1,
			duration: 0.5
		})
		
		// Zoom hacia Europa
		.to("#map-world", { 
			scale: 2.5, 
			transformOrigin: "500px 440px", 
			duration: 2.5,
			ease: "power2.inOut"
		}, "-=1")
		
		// Mostrar texto Europa con énfasis especial
		.to("#text-europe-group", { 
			opacity: 1, 
			y: -10,
			duration: 1.2,
			ease: "power2.out"
		}, "-=1")
		
		// Desvanecer la ruta al final
		.to("#flight-path", {
			opacity: 0.2,
			duration: 1.5
		}, "-=1")

        .to("#map-world", { 
			scale: 1, 
			x: 0, 
			y: 0,
			duration: 2.5,
			ease: "power2.inOut"
		}, "-=0.3");
	});
</script>