<section class="map__section">
	<div class="map__background">
		<div class="stars"></div>
		<div class="clouds"></div>
	</div>
	
	<div class="map__container">
		<svg
			id="flight-map"
			viewBox="0 180 1000 500"
			class="map-svg"
			preserveAspectRatio="xMidYMid slice"
		>
			<defs>
				<!-- Gradientes mejorados -->
				<linearGradient id="pathGradient" x1="0%" y1="0%" x2="100%" y2="0%">
					<stop offset="0%" style="stop-color:#60a5fa;stop-opacity:0.9" />
					<stop offset="50%" style="stop-color:#a78bfa;stop-opacity:0.9" />
					<stop offset="100%" style="stop-color:#f472b6;stop-opacity:0.9" />
				</linearGradient>
				
				<!-- Filtro de brillo mejorado -->
				<filter id="glow">
					<feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
					<feMerge>
						<feMergeNode in="coloredBlur"/>
						<feMergeNode in="SourceGraphic"/>
					</feMerge>
				</filter>
				
				<!-- Filtro para sombras suaves -->
				<filter id="softShadow" x="-50%" y="-50%" width="200%" height="200%">
					<feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
					<feOffset dx="0" dy="3" result="offsetblur"/>
					<feComponentTransfer>
						<feFuncA type="linear" slope="0.4"/>
					</feComponentTransfer>
					<feMerge> 
						<feMergeNode/>
						<feMergeNode in="SourceGraphic"/>
					</feMerge>
				</filter>
			</defs>
			
			<g id="map-world">
				<!-- MAPA -->
				<image
					href="/img/map/map.svg"
					width="1000"
					height="1000"
				/>

				<!-- RUTA USA → EUROPA -->
				<path
					id="flight-path"
					d="M220 480 C320 300, 400 300, 500 440"
					fill="none"
					stroke="url(#pathGradient)"
					stroke-width="2.5"
					stroke-dasharray="8 4"
					opacity="0"
				/>
				
				<!-- Partículas de estela del avión -->
				<g id="plane-trail">
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#60a5fa" opacity="0"/>
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#a78bfa" opacity="0"/>
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#f472b6" opacity="0"/>
				</g>

				<!-- AVIÓN con brillo -->
				<image
					id="plane"
					href="/img/map/plane.svg"
					width="35"
					height="35"
					x="0" 
					y="0"
					filter="url(#glow)"
				/>

				<!-- MARCADORES DE UBICACIÓN -->
				<g id="location-usa" opacity="0">
					<circle cx="220" cy="490" r="7" fill="#60a5fa" stroke="#ffffff" stroke-width="2"/>
					<circle cx="220" cy="490" r="9" fill="none" stroke="#60a5fa" stroke-width="2" opacity="0.5" class="pulse-ring"/>
				</g>
				
				<g id="location-europe" opacity="0">
					<circle cx="500" cy="450" r="7" fill="#f472b6" stroke="#ffffff" stroke-width="2"/>
					<circle cx="500" cy="450" r="9" fill="none" stroke="#f472b6" stroke-width="2" opacity="0.5" class="pulse-ring"/>
				</g>	

				<!-- TEXT -->
				<defs>
					<pattern id="usaFlagPattern" patternUnits="objectBoundingBox" width="1" height="1">
						<image href="/img/usa-flag.png" width="160" height="50" opacity="0.35" preserveAspectRatio="xMidYMid slice"/>
					</pattern>
				</defs>

				<g id="text-usa-group" opacity="0">
					<rect 
						x="140" 
						y="410" 
						width="160" 
						height="50" 
						rx="8" 
						fill="url(#usaFlagPattern)" 
						filter="url(#softShadow)"
					/>
					<text x="220" y="435" text-anchor="middle" class="map-text map-text-title">
						FROM
					</text>
					<text x="220" y="450" text-anchor="middle" class="map-text map-text-location">
						USA
					</text>
				</g>
				
				<g id="text-europe-group" opacity="0">
					<rect x="385" y="355" width="230" height="65" rx="8" fill="rgba(244, 114, 182, 0.95)" filter="url(#softShadow)"/>
					<text x="500" y="380" text-anchor="middle" class="map-text map-text-title">DESTINATION</text>
					<text x="500" y="400" text-anchor="middle" class="map-text map-text-dream">To Fulfill Your</text>
					<text x="500" y="415" text-anchor="middle" class="map-text map-text-dream-emphasis">Dreams</text>
				</g>
			</g>
		</svg>
	</div>
</section>

<style>
	.map__section {
		height: 100vh;
		display: flex;
		align-items: center;
		justify-content: center;
		position: relative;
		background: linear-gradient(180deg, #0f172a 0%, #1e293b 50%, #334155 100%);
		overflow: hidden;
	}
	
	.map__background {
		position: absolute;
		inset: 0;
		pointer-events: none;
	}
	
	/* Estrellas animadas mejoradas */
	.stars {
		position: absolute;
		inset: 0;
		background-image: 
			radial-gradient(2px 2px at 20% 30%, white, transparent),
			radial-gradient(2px 2px at 60% 70%, white, transparent),
			radial-gradient(1px 1px at 50% 50%, white, transparent),
			radial-gradient(1px 1px at 80% 10%, white, transparent),
			radial-gradient(2px 2px at 90% 60%, white, transparent),
			radial-gradient(1px 1px at 33% 80%, white, transparent),
			radial-gradient(1px 1px at 15% 60%, white, transparent),
			radial-gradient(2px 2px at 10% 10%, white, transparent),
			radial-gradient(2px 2px at 40% 20%, white, transparent),
			radial-gradient(1px 1px at 70% 85%, white, transparent),
			radial-gradient(2px 2px at 85% 35%, white, transparent),
			radial-gradient(1px 1px at 5% 90%, white, transparent),
			radial-gradient(1px 1px at 25% 55%, white, transparent),
			radial-gradient(2px 2px at 95% 15%, white, transparent),
			radial-gradient(1px 1px at 45% 45%, white, transparent),
			radial-gradient(2px 2px at 65% 5%, white, transparent),
			radial-gradient(1px 1px at 12% 40%, white, transparent),
			radial-gradient(2px 2px at 55% 95%, white, transparent),
			radial-gradient(1px 1px at 75% 50%, white, transparent),
			radial-gradient(2px 2px at 30% 75%, white, transparent);
		background-size: 200% 200%;
		animation: twinkle 6s ease-in-out infinite;
		opacity: 0.7;
	}
	
	@keyframes twinkle {
		0%, 100% { opacity: 0.5; }
		50% { opacity: 0.8; }
	}
	
	/* Nubes sutiles */
	.clouds {
		position: absolute;
		inset: 0;
		background: 
			radial-gradient(ellipse at 30% 40%, rgba(148, 163, 184, 0.08) 0%, transparent 50%),
			radial-gradient(ellipse at 70% 60%, rgba(148, 163, 184, 0.06) 0%, transparent 50%);
		animation: cloudMove 15s ease-in-out infinite;
	}
	
	@keyframes cloudMove {
		0%, 100% { transform: translateX(0); }
		50% { transform: translateX(15px); }
	}

	.map__container {
		width: 100%;
		display: flex;
		justify-content: center;
		z-index: 1;
	}

	.map-svg {
		width: 95%;
		max-width: 1200px;
		will-change: transform;
		overflow: visible;
		filter: drop-shadow(0 8px 25px rgba(96, 165, 250, 0.3));
	}

	.map-text {
		font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
		fill: white;
		pointer-events: none;
		letter-spacing: 0.5px;
	}
	
	.map-text-title {
		font-size: 14px;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 2px;
		opacity: 0.95;
	}
	
	.map-text-location {
		font-size: 22px;
		font-weight: 900;
		text-transform: uppercase;
		letter-spacing: 1px;
	}
	
	.map-text-dream {
		font-size: 18px;
		font-weight: 600;
		font-style: italic;
	}
	
	.map-text-dream-emphasis {
		font-size: 24px;
		font-weight: 900;
		text-transform: uppercase;
		letter-spacing: 2px;
		fill: #fef08a;
		filter: drop-shadow(0 0 6px rgba(254, 240, 138, 0.6));
	}
	
	/* Animación de pulso mejorada */
	@keyframes pulse {
		0%, 100% {
			r: 13;
			opacity: 0.5;
		}
		50% {
			r: 17;
			opacity: 0;
		}
	}
	
	.pulse-ring {
		animation: pulse 1.8s ease-out infinite;
	}
	
	/* Responsive */
	@media (max-width: 768px) {
		.map-text-title {
			font-size: 11px;
		}
		.map-text-location {
			font-size: 16px;
		}
		.map-text-dream {
			font-size: 13px;
		}
		.map-text-dream-emphasis {
			font-size: 18px;
		}
	}
</style>

<script>
	import { gsap } from "gsap";
	import { MotionPathPlugin } from "gsap/MotionPathPlugin";

	gsap.registerPlugin(MotionPathPlugin);

	// Configuración inicial del avión
	gsap.set("#plane", { 
		motionPath: {
			path: "#flight-path",
			align: "#flight-path",
			alignOrigin: [0.5, 0.5],
			start: 0,
			end: 0
		}
	});

	// Timeline automático optimizado
	const createMapAnimation = () => {
		const tl = gsap.timeline({
			defaults: { ease: "power2.inOut" }
		});

		return tl
			// === FASE 1: INTRO USA (1.8s) ===
			.to("#location-usa", { 
				opacity: 1, 
				scale: 1.15,
				duration: 0.5,
				ease: "back.out(1.5)"
			})
			.to("#location-usa", { 
				scale: 1,
				duration: 0.3
			})
			.to("#text-usa-group", { 
				opacity: 1, 
				y: -10,
				duration: 0.6
			}, "-=0.4")
			
			// Pausa breve (0.6s)
			.to({}, { duration: 0.6 })
			
			// === FASE 2: TRANSICIÓN (1.5s) ===
			.to("#text-usa-group", { 
				opacity: 0, 
				y: 10,
				duration: 0.5
			})
			.to("#map-world", { 
				scale: 1, 
				x: 0, 
				y: 0,
				duration: 1.2
			}, "-=0.1")
			
			// === FASE 3: VUELO (2.5s) ===
			.to("#flight-path", {
				opacity: 0.75,
				duration: 0.6
			}, "-=0.4")
			.to("#plane", {
				motionPath: {
					path: "#flight-path",
					align: "#flight-path",
					alignOrigin: [0.5, 0.5],
				},
				duration: 2,
				ease: "power1.inOut",
				onUpdate: function() {
					const progress = this.progress();
					gsap.to(".trail-particle", {
						opacity: 0.4 + (progress * 0.4),
						scale: 1 + (progress * 0.3),
						stagger: 0.08,
						duration: 0.2
					});
				}
			}, "-=0.2")
			.to("#plane", {
				scale: 1.1,
				duration: 0.25,
				yoyo: true,
				repeat: 2,
				ease: "sine.inOut",
				rotate: 6
			}, "-=1.5")
			
			// === FASE 4: DESTINO EUROPA (2s) ===
			.to("#location-europe", { 
				opacity: 1,
				scale: 1.15,
				duration: 0.5,
				ease: "back.out(1.5)"
			}, "-=0.8")
			.to("#location-europe", { 
				scale: 1,
				duration: 0.3
			})
			.to("#text-europe-group", { 
				opacity: 1, 
				y: -10,
				duration: 0.6
			}, "-=0.6")
			.to("#flight-path", {
				opacity: 0.3,
				duration: 0.8
			}, "-=0.8")
			
			// Pausa final (0.8s)
			.to({}, { duration: 0.8 })
			
	};

	// Intersection Observer para detectar visibilidad
	const mapSection = document.querySelector('.map__section');
	let hasPlayed = false;

	const observer = new IntersectionObserver(
		(entries) => {
			entries.forEach(entry => {
				if (entry.isIntersecting && !hasPlayed) {
					hasPlayed = true;
					const animation = createMapAnimation();
					animation.play();
					
					// Opcional: permitir replay al salir y volver a entrar
					// hasPlayed = false después de que la animación termine
					//animation.eventCallback("onComplete", () => {
					//	setTimeout(() => {
					//		hasPlayed = false;
					//	}, 2000);
					//});
				}
			});
		},
		{
			threshold: 0.25 // Inicia cuando el 25% de la sección es visible
		}
	);

	if (mapSection) {
		observer.observe(mapSection);
	}
</script>