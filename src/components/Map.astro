---
export interface MapSectionProps {
  id?: string;
  title: string;
  description: string;
  europe_top: string;
  europe_bot: string;
}

const props = Astro.props as MapSectionProps;

const {
  id = "map",
  title,
  description,
  europe_top,
  europe_bot
} = props;
---

<section class="map__section">
	<div class="map__background">
		<div class="stars"></div>
		<div class="stars stars-layer-2"></div>
		<div class="shooting-stars">
			<div class="shooting-star"></div>
			<div class="shooting-star"></div>
			<div class="shooting-star"></div>
		</div>
		<div class="clouds"></div>
		<div class="nebula nebula-1"></div>
		<div class="nebula nebula-2"></div>
	</div>
	
	<!-- Título Superior -->
	<div class="map__title">
		<h2 class="title-main" data-i18n="map.title">{title}</h2>
		<p class="title-subtitle" data-i18n="map.description">{description}</p>
	</div>
	
	<div class="map__container">
		<svg
			id="flight-map"
			viewBox="0 180 1000 500"
			class="map-svg"
			preserveAspectRatio="xMidYMid slice"
		>
			<defs>
				<!-- Gradientes mejorados -->
				<linearGradient id="pathGradient" x1="0%" y1="0%" x2="100%" y2="0%">
					<stop offset="0%" style="stop-color:#60a5fa;stop-opacity:0.9" />
					<stop offset="50%" style="stop-color:#a78bfa;stop-opacity:0.9" />
					<stop offset="100%" style="stop-color:#f472b6;stop-opacity:0.9" />
				</linearGradient>
				
				<!-- Filtro de brillo mejorado -->
				<filter id="glow">
					<feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
					<feMerge>
						<feMergeNode in="coloredBlur"/>
						<feMergeNode in="SourceGraphic"/>
					</feMerge>
				</filter>
				
				<!-- Filtro para sombras suaves -->
				<filter id="softShadow" x="-50%" y="-50%" width="200%" height="200%">
					<feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
					<feOffset dx="0" dy="3" result="offsetblur"/>
					<feComponentTransfer>
						<feFuncA type="linear" slope="0.4"/>
					</feComponentTransfer>
					<feMerge> 
						<feMergeNode/>
						<feMergeNode in="SourceGraphic"/>
					</feMerge>
				</filter>
			</defs>
			
			<g id="map-world">
				<!-- MAPA -->
				<image
					href="/img/map/map.svg"
					width="1000"
					height="1000"
				/>

				<path
					id="flight-path"
					d="M220 480 C300 300, 400 300, 475 450"
					fill="none"
					stroke="url(#pathGradient)"
					stroke-width="2.5"
					stroke-dasharray="8 4"
					opacity="0"
				/>
				
				<!-- Partículas de estela del avión -->
				<g id="plane-trail-usa">
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#60a5fa" opacity="0"/>
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#a78bfa" opacity="0"/>
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#f472b6" opacity="0"/>
				</g>
				<g id="plane-trail-col">
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#60a5fa" opacity="0"/>
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#a78bfa" opacity="0"/>
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#f472b6" opacity="0"/>
				</g>
				<g id="plane-trail-australia">
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#60a5fa" opacity="0"/>
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#a78bfa" opacity="0"/>
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#f472b6" opacity="0"/>
				</g>
				<g id="plane-trail-japon">
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#60a5fa" opacity="0"/>
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#a78bfa" opacity="0"/>
					<circle class="trail-particle" cx="0" cy="0" r="1.5" fill="#f472b6" opacity="0"/>
				</g>

				<!-- AVIÓN con brillo - USA -->
				<image
					id="plane-usa"
					href="/img/map/plane.svg"
					width="35"
					height="35"
					x="0" 
					y="0"
					filter="url(#glow)"
					opacity="0"
				/>
				<!-- AVIÓN con brillo - Colombia -->
				<image
					id="plane-col"
					href="/img/map/plane.svg"
					width="35"
					height="35"
					x="0" 
					y="0"
					filter="url(#glow)"
					opacity="0"
				/>
				<!-- AVIÓN con brillo - Australia -->
				<image
					id="plane-australia"
					href="/img/map/plane.svg"
					width="35"
					height="35"
					x="0" 
					y="0"
					filter="url(#glow)"
					opacity="0"
				/>
				<!-- AVIÓN con brillo - Japón -->
				<image
					id="plane-japon"
					href="/img/map/plane.svg"
					width="35"
					height="35"
					x="0" 
					y="0"
					filter="url(#glow)"
					opacity="0"
				/>

				<!-- MARCADORES DE UBICACIÓN -->
				<g id="location-usa" opacity="0">
					<circle cx="220" cy="490" r="7" fill="#60a5fa" stroke="#ffffff" stroke-width="2"/>
					<circle cx="220" cy="490" r="9" fill="none" stroke="#60a5fa" stroke-width="2" opacity="0.5" class="pulse-ring"/>
				</g>

				<g id="location-col" opacity="0">
					<circle cx="285" cy="572" r="7" fill="#60a5fa" stroke="#ffffff" stroke-width="2"/>
					<circle cx="285" cy="572" r="9" fill="none" stroke="#60a5fa" stroke-width="2" opacity="0.5" class="pulse-ring"/>
				</g>

				<g id="location-australia" opacity="0">
					<circle cx="800" cy="650" r="7" fill="#60a5fa" stroke="#ffffff" stroke-width="2"/>
					<circle cx="800" cy="650" r="9" fill="none" stroke="#60a5fa" stroke-width="2" opacity="0.5" class="pulse-ring"/>
				</g>

				<g id="location-japon" opacity="0">
					<circle cx="780" cy="450" r="7" fill="#60a5fa" stroke="#ffffff" stroke-width="2"/>
					<circle cx="780" cy="450" r="9" fill="none" stroke="#60a5fa" stroke-width="2" opacity="0.5" class="pulse-ring"/>
				</g>
				
				<g id="location-europe" opacity="0">
					<circle cx="475" cy="450" r="7" fill="#f472b6" stroke="#ffffff" stroke-width="2"/>
					<circle cx="475" cy="450" r="9" fill="none" stroke="#f472b6" stroke-width="2" opacity="0.5" class="pulse-ring"/>
				</g>	

				<!-- TEXT -->

				<defs>
					<pattern id="franceFlagPattern" patternUnits="objectBoundingBox" width="1" height="1">
						<image href="/img/france-flag.png" width="230" height="65" opacity="0.35" preserveAspectRatio="xMidYMid slice"/>
					</pattern>
				</defs>
				
				<g id="text-europe-group" opacity="0">
					<rect 
						x="385" 
						y="355" 
						width="230"
						height="65" 
						rx="8"
						fill="url(#franceFlagPattern)" 
						filter="url(#softShadow)"
					/>
					<text x="500" y="375" text-anchor="middle" class="map-text map-text-title" data-i18n="map.europe_top">{europe_top}</text>
					<text x="500" y="410" text-anchor="middle" class="map-text map-text-dream-emphasis" data-i18n="map.europe_bot">{europe_bot}</text>
				</g>
			</g>
		</svg>
	</div>
</section>

<style>
	.map__section {
		height: 100vh;
		display: flex;
		align-items: center;
		justify-content: center;
		position: relative;
		background: #313e52;
		overflow: hidden;
		@media screen and (max-width: 768px) {
			height: 50vh;
		}
	}
	
	.map__background {
		position: absolute;
		inset: 0;
		pointer-events: none;
	}
	
	/* Título Superior */
	.map__title {
		width: 80%;
		position: absolute;
		top: 8%;
		left: 50%;
		transform: translateX(-50%);
		text-align: center;
		z-index: 10;
	}
	
	.title-main {
		font-size: clamp(1.5rem, 4vw, 2.5rem);
		font-weight: 800;
		color: white;
		margin: 0;
		letter-spacing: 1px;
	}
	
	.title-subtitle {
		font-size: clamp(0.875rem, 2vw, 1.125rem);
		color: rgba(255, 255, 255, 0.7);
		margin: 0.5rem 0 0 0;
		font-weight: 500;
		text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
	}
	
	/* Estrellas - Capa 1 (más grandes) */
	.stars {
		position: absolute;
		inset: 0;
		background-image: 
			radial-gradient(2px 2px at 20% 30%, white, transparent),
			radial-gradient(2px 2px at 60% 70%, white, transparent),
			radial-gradient(1px 1px at 50% 50%, white, transparent),
			radial-gradient(1px 1px at 80% 10%, white, transparent),
			radial-gradient(2px 2px at 90% 60%, white, transparent),
			radial-gradient(1px 1px at 33% 80%, white, transparent),
			radial-gradient(1px 1px at 15% 60%, white, transparent),
			radial-gradient(2px 2px at 10% 10%, white, transparent),
			radial-gradient(2px 2px at 40% 20%, white, transparent),
			radial-gradient(1px 1px at 70% 85%, white, transparent),
			radial-gradient(2px 2px at 85% 35%, white, transparent),
			radial-gradient(1px 1px at 5% 90%, white, transparent),
			radial-gradient(1px 1px at 25% 55%, white, transparent),
			radial-gradient(2px 2px at 95% 15%, white, transparent),
			radial-gradient(1px 1px at 45% 45%, white, transparent),
			radial-gradient(2px 2px at 65% 5%, white, transparent),
			radial-gradient(1px 1px at 12% 40%, white, transparent),
			radial-gradient(2px 2px at 55% 95%, white, transparent),
			radial-gradient(1px 1px at 75% 50%, white, transparent),
			radial-gradient(2px 2px at 30% 75%, white, transparent),
			radial-gradient(3px 3px at 88% 48%, rgba(96, 165, 250, 0.8), transparent),
			radial-gradient(2px 2px at 22% 68%, rgba(167, 139, 250, 0.8), transparent),
			radial-gradient(2px 2px at 78% 22%, rgba(244, 114, 182, 0.8), transparent);
		background-size: 250% 250%;
		animation: twinkle 8s ease-in-out infinite;
		opacity: 0.9;
	}
	
	/* Estrellas - Capa 2 (más pequeñas y numerosas) */
	.stars-layer-2 {
		background-image: 
			radial-gradient(1px 1px at 18% 25%, white, transparent),
			radial-gradient(1px 1px at 42% 55%, white, transparent),
			radial-gradient(1px 1px at 67% 38%, white, transparent),
			radial-gradient(1px 1px at 31% 72%, white, transparent),
			radial-gradient(1px 1px at 89% 83%, white, transparent),
			radial-gradient(1px 1px at 14% 47%, white, transparent),
			radial-gradient(1px 1px at 53% 19%, white, transparent),
			radial-gradient(1px 1px at 76% 91%, white, transparent),
			radial-gradient(1px 1px at 38% 8%, white, transparent),
			radial-gradient(1px 1px at 92% 34%, white, transparent),
			radial-gradient(1px 1px at 27% 62%, white, transparent),
			radial-gradient(1px 1px at 61% 77%, white, transparent),
			radial-gradient(1px 1px at 8% 88%, white, transparent),
			radial-gradient(1px 1px at 94% 12%, white, transparent),
			radial-gradient(1px 1px at 48% 43%, white, transparent),
			radial-gradient(1px 1px at 71% 58%, white, transparent),
			radial-gradient(1px 1px at 19% 33%, white, transparent),
			radial-gradient(1px 1px at 83% 69%, white, transparent),
			radial-gradient(1px 1px at 36% 94%, white, transparent),
			radial-gradient(1px 1px at 58% 6%, white, transparent);
		animation: twinkle 10s ease-in-out infinite reverse;
		opacity: 0.6;
	}
	
	@keyframes twinkle {
		0%, 100% { opacity: 0.4; }
		50% { opacity: 1; }
	}
	
	/* Estrellas Fugaces */
	.shooting-stars {
		position: absolute;
		inset: 0;
	}
	
	.shooting-star {
		position: absolute;
		width: 2px;
		height: 2px;
		background: white;
		border-radius: 50%;
		box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.1),
		            0 0 0 4px rgba(255, 255, 255, 0.05),
		            0 0 10px rgba(255, 255, 255, 0.5);
		animation: shootingStar 3s linear infinite;
	}
	
	.shooting-star:nth-child(1) {
		top: 10%;
		left: 80%;
		animation-delay: 0s;
	}
	
	.shooting-star:nth-child(2) {
		top: 30%;
		left: 60%;
		animation-delay: 4s;
	}
	
	.shooting-star:nth-child(3) {
		top: 50%;
		left: 90%;
		animation-delay: 7s;
	}
	
	@keyframes shootingStar {
		0% {
			transform: translateX(0) translateY(0);
			opacity: 1;
		}
		70% {
			opacity: 1;
		}
		100% {
			transform: translateX(-300px) translateY(300px);
			opacity: 0;
		}
	}
	
	/* Nebulosas de Fondo */
	.nebula {
		position: absolute;
		border-radius: 50%;
		filter: blur(60px);
		opacity: 0.15;
		animation: nebulaFloat 20s ease-in-out infinite;
	}
	
	.nebula-1 {
		width: 400px;
		height: 400px;
		background: radial-gradient(circle, rgba(96, 165, 250, 0.4) 0%, transparent 70%);
		top: 10%;
		left: 10%;
		animation-delay: 0s;
	}
	
	.nebula-2 {
		width: 350px;
		height: 350px;
		background: radial-gradient(circle, rgba(167, 139, 250, 0.3) 0%, transparent 70%);
		bottom: 15%;
		right: 15%;
		animation-delay: 5s;
	}
	
	@keyframes nebulaFloat {
		0%, 100% {
			transform: translate(0, 0) scale(1);
		}
		33% {
			transform: translate(30px, -20px) scale(1.1);
		}
		66% {
			transform: translate(-20px, 30px) scale(0.95);
		}
	}
	
	/* Nubes sutiles */
	.clouds {
		position: absolute;
		inset: 0;
		background: 
			radial-gradient(ellipse at 30% 40%, rgba(148, 163, 184, 0.05) 0%, transparent 50%),
			radial-gradient(ellipse at 70% 60%, rgba(148, 163, 184, 0.03) 0%, transparent 50%);
		animation: cloudMove 15s ease-in-out infinite;
	}
	
	@keyframes cloudMove {
		0%, 100% { transform: translateX(0); }
		50% { transform: translateX(15px); }
	}

	.map__container {
		width: 100%;
		display: flex;
		justify-content: center;
		z-index: 1;
	}

	.map-svg {
		width: 95%;
		max-width: 1200px;
		will-change: transform;
		overflow: visible;
		filter: drop-shadow(0 8px 25px rgba(96, 165, 250, 0.3));
	}

	.map-text {
		fill: white;
		pointer-events: none;
		letter-spacing: 0.5px;
	}
	
	.map-text-title {
		font-size: 14px;
		font-weight: 700;
		text-transform: uppercase;
		letter-spacing: 2px;
		opacity: 0.95;
	}
	
	.map-text-location {
		font-size: 22px;
		font-weight: 900;
		text-transform: uppercase;
		letter-spacing: 1px;
	}
	
	.map-text-dream {
		font-size: 18px;
		font-weight: 600;
		font-style: italic;
	}
	
	.map-text-dream-emphasis {
		font-size: 24px;
		font-weight: 900;
		text-transform: uppercase;
		letter-spacing: 2px;
		fill: #fef08a;
		filter: drop-shadow(0 0 6px rgba(254, 240, 138, 0.6));
	}
	
	/* Animación de pulso mejorada */
	@keyframes pulse {
		0%, 100% {
			r: 13;
			opacity: 0.5;
		}
		50% {
			r: 17;
			opacity: 0;
		}
	}
	
	.pulse-ring {
		animation: pulse 1.8s ease-out infinite;
	}
	
	/* Responsive */
	@media (max-width: 768px) {
		.map__title {
			top: 5%;
		}
		
		.title-main {
			font-size: 1.25rem;
		}
		
		.title-subtitle {
			font-size: 0.75rem;
		}
		
		.map-text-title {
			font-size: 11px;
		}
		.map-text-location {
			font-size: 16px;
		}
		.map-text-dream {
			font-size: 13px;
		}
		.map-text-dream-emphasis {
			font-size: 18px;
		}
		
		.nebula-1,
		.nebula-2 {
			width: 250px;
			height: 250px;
		}
	}
</style>

<script>
	import { gsap } from "gsap";
	import { MotionPathPlugin } from "gsap/MotionPathPlugin";

	gsap.registerPlugin(MotionPathPlugin);

	const EUROPE_X = 475;
	const EUROPE_Y = 450;

	const ROUTES = [
		{ id: "usa", markerSelector: "#location-usa", fromX: 220, fromY: 490, planeId: "#plane-usa", trailId: "#plane-trail-usa" },
		{ id: "col", markerSelector: "#location-col", fromX: 285, fromY: 572, planeId: "#plane-col", trailId: "#plane-trail-col" },
		{ id: "australia", markerSelector: "#location-australia", fromX: 800, fromY: 650, planeId: "#plane-australia", trailId: "#plane-trail-australia" },
		{ id: "japon", markerSelector: "#location-japon", fromX: 780, fromY: 450, planeId: "#plane-japon", trailId: "#plane-trail-japon" },
	];

	const buildPath = (fromX: number, fromY: number) => {
		const isComingFromEast = fromX > EUROPE_X;
		const offset = isComingFromEast ? -60 : 60;
		const height = 100; // Altura consistente para simetría
		const ctrl1X = fromX + offset;
		const ctrl1Y = fromY - height;
		const ctrl2X = EUROPE_X - offset;
		const ctrl2Y = EUROPE_Y - height;
		return `M ${fromX} ${fromY} C ${ctrl1X} ${ctrl1Y}, ${ctrl2X} ${ctrl2Y}, ${EUROPE_X} ${EUROPE_Y}`;
	};

	const resetToInitialState = () => {
		const firstRoute = ROUTES[0];

		gsap.set("#flight-path", {
			attr: { d: buildPath(firstRoute.fromX, firstRoute.fromY) },
			opacity: 0,
		});

		// Reset all planes
		ROUTES.forEach((route) => {
			const pathD = buildPath(route.fromX, route.fromY);
			gsap.set("#flight-path", {
				attr: { d: pathD },
			});
			const isComingFromEast = route.fromX > EUROPE_X;
			gsap.set(route.planeId, {
				motionPath: {
					path: "#flight-path",
					align: "#flight-path",
					alignOrigin: [0.5, 0.5],
					autoRotate: true,
					start: 0,
					end: 0,
				},
				scale: 1,
				scaleY: isComingFromEast ? -1 : 1,
				opacity: 0,
			});
		});

		gsap.set("#map-world", { scale: 1, x: 0, y: 0 });
		gsap.set("#text-europe-group", { opacity: 0, y: 0 });
		gsap.set("#destino-europa-group", { opacity: 0, y: 0 });
		gsap.set(".trail-particle", { opacity: 0, scale: 1 });

		gsap.set("#location-europe", { opacity: 1, scale: 1 });
		ROUTES.forEach((route) => {
			gsap.set(route.markerSelector, { opacity: 1, scale: 1 });
		});
	};

	const createMapAnimation = () => {
		const tl = gsap.timeline({
			defaults: { ease: "power2.inOut" },
		});

		// Zoom inicial del mapa
		tl.to("#map-world", {
			scale: 1.2,
			x: -100,
			y: -100,
			duration: 1.2,
		});

		// Animar cada avión secuencialmente
		ROUTES.forEach((route, index) => {
			const pathD = buildPath(route.fromX, route.fromY);

			tl.set("#flight-path", {
				attr: { d: pathD },
			});

			// Mostrar y animar el marcador de origen
			tl.to(route.markerSelector, {
				scale: 1.3,
				duration: 0.3,
				yoyo: true,
				repeat: 1,
			});

			// Posicionar el avión en su punto de origen y hacerlo visible
			const isComingFromEast = route.fromX > EUROPE_X;
			tl.set(route.planeId, {
				opacity: 1,
				scaleY: isComingFromEast ? -1 : 1,
				motionPath: {
					path: "#flight-path",
					align: "#flight-path",
					alignOrigin: [0.5, 0.5],
					autoRotate: true,
					start: 0,
					end: 0,
				},
			});

			// Mostrar la ruta
			tl.to("#flight-path", {
				opacity: 0.75,
				duration: 0.5,
			});

			// Animar el avión hacia Europa
			tl.to(
				route.planeId,
				{
					motionPath: {
						path: "#flight-path",
						align: "#flight-path",
						alignOrigin: [0.5, 0.5],
						autoRotate: true,
						start: 0,
						end: 1,
					},
					duration: 2.5,
					ease: "power1.inOut",
					onUpdate: function () {
						const progress = this.progress();
						const trailParticles = document.querySelectorAll(`${route.trailId} .trail-particle`);
						trailParticles.forEach((particle, i) => {
							gsap.to(particle, {
								opacity: 0.4 + progress * 0.4,
								scale: 1 + progress * 0.3,
								duration: 0.2,
								delay: i * 0.08,
							});
						});
					},
				},
				"-=0.1"
			);

			// Ocultar el avión al llegar (sin temblor)
			tl.to(route.planeId, {
				opacity: 0,
				duration: 0.3,
			});

			// Ocultar la ruta
			tl.to(
				"#flight-path",
				{
					opacity: 0.2,
					duration: 0.8,
				},
				"-=0.5"
			);

			// Ocultar partículas de estela
			tl.to(
				`${route.trailId} .trail-particle`,
				{
					opacity: 0,
					duration: 0.4,
				},
				"-=0.3"
			);

			// Pequeña pausa antes del siguiente avión
			tl.to({}, { duration: 0.3 });
		});

		tl.to(
			"#flight-path",
			{
				opacity: 0,
				duration: 0.6,
			},
			"-=0.6"
		);

		// Mostrar el texto de Europa
		tl.to("#text-europe-group", {
			opacity: 1,
			y: -10,
			duration: 0.6,
		});

		return tl;
	};

	const mapSection = document.querySelector(".map__section");

	if (mapSection) {
		resetToInitialState();

		let animation: gsap.core.Timeline | null = null;

		const observer = new IntersectionObserver(
			(entries) => {
				entries.forEach((entry) => {
					if (entry.isIntersecting) {
						if (!animation) {
							animation = createMapAnimation();
						}
						animation.restart();
					} else {
						if (animation) {
							animation.pause(0);
						}
						resetToInitialState();
					}
				});
			},
			{
				threshold: 0.2,
			}
		);

		observer.observe(mapSection);
	}
</script>
