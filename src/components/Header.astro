---
import { Icon } from "astro-icon/components";
import Logo from "./Logo.astro";
import Button from "./Button.astro";
import LanguageSelector from "./LanguageSelector.astro";

export interface NavItem {
  label: string;
  href: string;
  i18nKey?: string;
}

export interface HeaderProps {
  logo: {
    src: string;
    alt?: string;
    href?: string;
  };
  navItems: NavItem[];
  cta?: {
    label: string;
    href: string;
    i18nKey?: string;
  };
}

const props = Astro.props as HeaderProps;
const { logo, navItems, cta } = props;

// ðŸ‘‰ active path
const pathname = Astro.url.pathname;
---

<header 
  id="main-header"
  x-data="{ open: false }" 
  class="fixed top-4 left-0 right-0 z-50 transition-transform duration-300 ease-in-out"
>
  <div class="mx-auto max-w-6xl px-4">
    <div
      class="flex h-16 items-center justify-between rounded-2xl border border-white/10 bg-black/30 backdrop-blur-md"
    >
      <!-- Logo -->
      <div class="px-4">
        <Logo
          src={logo.src}
          alt={logo.alt}
          href={logo.href}
        />
      </div>

      <!-- Desktop Menu -->
      <nav class="hidden md:flex items-center gap-6 px-4">
        {navItems.map((item: NavItem) => {
          const isActive =
            item.href === "/"
              ? pathname === "/"
              : pathname.startsWith(item.href);

          return (
            <a
              href={item.href}
              data-i18n={item.i18nKey || undefined}
              class={`text-sm font-medium transition
                ${isActive ? "active text-white" : "text-white/80 hover:text-white"}
              `}
            >
              {item.label}
            </a>
          );
        })}

        {cta && (
          <Button
            href={cta.href}
            label={cta.label}
            variant="white"
            className="ml-2"
            i18nKey={cta.i18nKey}
          />
        )}
        
        <div class="ml-4">
          <LanguageSelector />
        </div>
      </nav>

      <!-- Mobile Toggle -->
      <button
        @click="open = !open"
        aria-label="mobile menu"
        class="mr-4 flex md:hidden items-center justify-center rounded-lg border border-white/20 size-10 text-white"
      >
        <Icon x-show="!open" name="bi:list" class="text-xl" />
        <Icon
          x-show="open"
          name="bi:x-lg"
          class="text-xl"
          style="display:none;"
        />
      </button>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div
    x-show="open"
    style="display:none;"
    @click.outside="open = false"
    class="md:hidden px-4 pt-2"
  >
    <div
      class="space-y-3 rounded-2xl border border-white/10 bg-black/40 backdrop-blur-md p-4"
    >
      {navItems.map((item: NavItem) => {
        const isActive =
          item.href === "/"
            ? pathname === "/"
            : pathname.startsWith(item.href);

        return (
          <a
            href={item.href}
            data-i18n={item.i18nKey || undefined}
            class={`block transition
              ${isActive ? "active text-white" : "text-white/80 hover:text-white"}
            `}
          >
            {item.label}
          </a>
        );
      })}

      {cta && (
        <Button
          href={cta.href}
          label={cta.label}
          variant="white"
          className="mt-3 w-full"
          i18nKey={cta.i18nKey}
        />
      )}
      
      <div class="mt-3">
        <LanguageSelector />
      </div>
    </div>
  </div>
</header>

<script>
  /**
   * Header Scroll Logic
   */
  const header = document.getElementById('main-header');
  let lastScrollY = window.pageYOffset;
  let isScrolling = false;
  const scrollOffset = 50; // Minimum scroll before hiding

  const handleScroll = () => {
    const currentScrollY = window.pageYOffset;
    
    // Always show at the top
    if (currentScrollY <= 0) {
      header?.classList.remove('-translate-y-[150%]');
      lastScrollY = currentScrollY;
      return;
    }

    // Determine direction
    const diff = Math.abs(currentScrollY - lastScrollY);
    
    if (diff > scrollOffset) {
      if (currentScrollY > lastScrollY) {
        // Scrolling down - hide
        header?.classList.add('-translate-y-[150%]');
      } else {
        // Scrolling up - show
        header?.classList.remove('-translate-y-[150%]');
      }
      lastScrollY = currentScrollY;
    }
  };

  // Efficient Throttling (approx 10 events per second)
  window.addEventListener('scroll', () => {
    if (!isScrolling) {
      window.requestAnimationFrame(() => {
        handleScroll();
        setTimeout(() => {
          isScrolling = false;
        }, 100);
      });
      isScrolling = true;
    }
  }, { passive: true });
</script>