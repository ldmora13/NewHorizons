---
import { Icon } from "astro-icon/components";

export interface TourGalleryProps {
  title: string;
  cover: string;
  duration: string;
  gallery?: string[];
}

const {
  title,
  cover,
  duration,
  gallery = [],
} = Astro.props as TourGalleryProps;

// Pastikan cover selalu masuk ke gallery
const images = gallery.length ? gallery : [cover];

// Unique ID untuk multiple instances
const uniqueId = Math.random().toString(36).slice(2, 9);
const mainImageId = `mainImage-${uniqueId}`;
const mainLinkId = `mainLink-${uniqueId}`;
const galleryDataAttr = `tour-gallery-${uniqueId}`;
---

<div class="tour-gallery-container" data-unique-id={uniqueId}>
  <!-- Main Image -->
  <div class="relative rounded-3xl overflow-hidden aspect-[4/2.6] border border-white/10 mb-4">
    <a id={mainLinkId} href="#" class="cursor-zoom-in block">
      <img
        id={mainImageId}
        src={images[0]}
        alt={title}
        class="w-full h-full object-cover transition duration-500"
      />
    </a>
    <span class="bg-white/90 px-6 py-1 rounded-full text-black font-semibold absolute top-4 left-4">
      <Icon name="bi:clock" class="inline w-4 h-4 mr-2" />
      {duration}
    </span>
  </div>

  <!-- GLightbox Gallery Source (Hidden) -->
  <div class="hidden">
    {images.map((img) => (
      <a href={img} class="glightbox" data-gallery={galleryDataAttr}></a>
    ))}
  </div>

  <!-- Thumbnails -->
  {images.length > 1 && (
    <div class="grid grid-cols-4 gap-3">
      {images.map((img, index) => (
        <button
          type="button"
          class={`thumbnail-button rounded-xl overflow-hidden border transition ${
            index === 0 ? 'border-white/20' : 'border-white/10'
          } hover:border-white/60`}
          data-image={img}
          data-index={index}
          data-unique-id={uniqueId}
        >
          <img 
            src={img} 
            class="w-full h-20 object-cover" 
            alt={`${title} ${index + 1}`}
            loading="lazy"
          />
        </button>
      ))}
    </div>
  )}
</div>

<script>
  import GLightbox from 'glightbox';

  // Function to initialize a single gallery
  function initGallery(container: HTMLElement) {
    const uniqueId = container.dataset.uniqueId;
    if (!uniqueId) return;

    const mainImageId = `mainImage-${uniqueId}`;
    const mainLinkId = `mainLink-${uniqueId}`;
    const galleryDataAttr = `tour-gallery-${uniqueId}`;

    const mainImage = document.getElementById(mainImageId) as HTMLImageElement;
    const mainLink = document.getElementById(mainLinkId) as HTMLAnchorElement;
    const thumbnails = container.querySelectorAll<HTMLButtonElement>(
      `.thumbnail-button[data-unique-id="${uniqueId}"]`
    );

    if (!mainImage || !mainLink || thumbnails.length === 0) return;

    let activeIndex = 0;

    // Init GLightbox untuk gallery ini
    const lightbox = GLightbox({
      selector: `.glightbox[data-gallery="${galleryDataAttr}"]`,
    });

    // Function changeImage - seperti aslinya
    function changeImage(button: HTMLButtonElement, index: number) {
      const imageSrc = button.dataset.image;
      if (!imageSrc) return;

      mainImage.src = imageSrc;
      activeIndex = index;

      // Update border styling
      thumbnails.forEach((btn, i) => {
        if (i === index) {
          btn.classList.remove('border-white/10');
          btn.classList.add('border-white/20');
        } else {
          btn.classList.remove('border-white/20');
          btn.classList.add('border-white/10');
        }
      });
    }

    // Event listener untuk thumbnails
    thumbnails.forEach((button, index) => {
      button.addEventListener('click', () => {
        changeImage(button, index);
      });
    });

    // Event listener untuk main link - seperti aslinya
    mainLink.addEventListener('click', (e) => {
      e.preventDefault();
      lightbox.openAt(activeIndex);
    });
  }

  // Initialize all galleries on page load
  function initAllGalleries() {
    document.querySelectorAll<HTMLElement>('.tour-gallery-container').forEach((container) => {
      // Prevent double initialization
      if (container.dataset.initialized === 'true') return;
      container.dataset.initialized = 'true';

      initGallery(container);
    });
  }

  // Run on page load
  document.addEventListener('astro:page-load', initAllGalleries);

  // Fallback for non-Astro environments
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initAllGalleries);
  } else {
    initAllGalleries();
  }
</script>