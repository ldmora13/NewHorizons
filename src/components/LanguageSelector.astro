---
// Componente selector de idioma para proyectos estÃ¡ticos
---

<div 
  class="relative inline-block language-selector-container"
  x-data="{
    open: false,
    currentLang: localStorage.getItem('i18nextLng') || navigator.language?.split('-')[0] || 'es'
  }"
  x-init="
    // Keep Alpine in sync when i18n changes language
    window.addEventListener('i18n:changed', (e) => { currentLang = e.detail.lang; });
    // Ensure currentLang is a supported language
    if (!['en','es','fr'].includes(currentLang)) currentLang = 'es';
  "
>
  <!-- Language Button -->
  <button
    @click="open = !open"
    @click.outside="open = false"
    class="flex items-center gap-2 rounded-lg border border-white/20 bg-black/30 px-3 py-2 text-sm text-white hover:bg-black/50 transition"
    aria-label="Select language"
  >
    <span x-text="currentLang.toUpperCase()"></span>
    <svg 
      class="w-4 h-4 transition-transform"
      :class="{ 'rotate-180': open }"
      fill="none" 
      stroke="currentColor" 
      viewBox="0 0 24 24"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
    </svg>
  </button>

  <!-- Dropdown Menu -->
  <div
    x-show="open"
    x-transition
    style="display: none;"
    class="absolute left-0 md:right-0 mt-2 w-48 rounded-lg border border-white/10 bg-black backdrop-blur-md shadow-lg z-50"
  >
    <div class="py-1">
      <button
        data-lang="en"
        @click="open = false"
        class="w-full flex items-center gap-3 px-4 py-2 text-sm text-white hover:bg-white/10 transition text-left"
        :class="{ 'bg-white/10 font-semibold': currentLang === 'en' }"
      >
        <span class="text-xl">ğŸ‡ºğŸ‡¸</span>
        <span>English</span>
      </button>
      <button
        data-lang="es"
        @click="open = false"
        class="w-full flex items-center gap-3 px-4 py-2 text-sm text-white hover:bg-white/10 transition text-left"
        :class="{ 'bg-white/10 font-semibold': currentLang === 'es' }"
      >
        <span class="text-xl">ğŸ‡ªğŸ‡¸</span>
        <span>EspaÃ±ol</span>
      </button>
      <button
        data-lang="fr"
        @click="open = false"
        class="w-full flex items-center gap-3 px-4 py-2 text-sm text-white hover:bg-white/10 transition text-left"
        :class="{ 'bg-white/10 font-semibold': currentLang === 'fr' }"
      >
        <span class="text-xl">ğŸ‡«ğŸ‡·</span>
        <span>FranÃ§ais</span>
      </button>
      <button
        data-lang="pt"
        class="w-full flex items-center gap-3 px-4 py-2 text-sm text-white hover:bg-white/10 transition text-left"
      >
        <span class="text-xl">ğŸ‡µğŸ‡¹</span>
        <span>PortuguÃªs</span>
      </button>
    </div>
  </div>
</div>

<script is:inline>
  (function initLanguageSelector() {
    function setup() {
      const selectors = document.querySelectorAll('.language-selector-container');
      if (selectors.length === 0) return;

      // Handle language button clicks
      selectors.forEach(selector => {
        const buttons = selector.querySelectorAll('button[data-lang]');
        buttons.forEach((button) => {
          button.addEventListener('click', async (e) => {
            e.preventDefault();
            e.stopPropagation();

            const lang = button.getAttribute('data-lang');
            if (!lang || !['en', 'es', 'fr', 'pt'].includes(lang)) return;

            try {
              // Wait for i18n to be ready if not yet initialized
              if (!window.i18n) {
                await new Promise((resolve) => {
                  const interval = setInterval(() => {
                    if (window.i18n) { clearInterval(interval); resolve(); }
                  }, 50);
                  setTimeout(() => { clearInterval(interval); resolve(); }, 3000);
                });
              }

              if (window.i18n && window.i18n.changeLanguage) {
                await window.i18n.changeLanguage(lang);
              }
            } catch (err) {
              console.error('Error changing language:', err);
            }
          });
        });
      });
    }

    // Run immediately â€” buttons use event delegation so this is safe
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setup);
    } else {
      setup();
    }
  })();
</script>
