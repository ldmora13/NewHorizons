---
const paypalClientId = import.meta.env.PUBLIC_PAYPAL_CLIENT_ID;
---
<div id="paypal-container-wrapper" class="hidden space-y-4">
  <div id="paypal-button-container" class="pt-4 min-h-37.5">
    <!-- PayPal Buttons will be rendered here -->
    <div class="text-center text-white/50 text-sm animate-pulse">Initializing PayPal...</div>
  </div>
  <p class="text-xs text-white/40 text-center">
    Secure payment processed by PayPal. All transactions are encrypted.
  </p>
</div>

<script
  is:inline
  src={`https://www.paypal.com/sdk/js?client-id=${paypalClientId}&currency=USD`} />

<script>
  window.addEventListener('init-paypal', (e: any) => {
    const { programId, adults, children, amount, clientDetails, onApprove, onError } = e.detail;

    const wrapper   = document.getElementById('paypal-container-wrapper');
    const container = document.getElementById('paypal-button-container');
    
    if (!wrapper || !container) return;
    
    wrapper.classList.remove('hidden');
    container.innerHTML = '';

    const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000/api';

    // @ts-ignore
    if (!window.paypal) {
      onError(new Error('PayPal SDK not loaded'));
      return;
    }

    // @ts-ignore
    window.paypal.Buttons({

      createOrder: async () => {
        const response = await fetch(`${API_URL}/public/checkout/init`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ programId, adults, children, amount })
        });

        // Guard: si el servidor devuelve HTML (404/500) esto previene el JSON.parse crash
        const contentType = response.headers.get('content-type') ?? '';
        if (!response.ok || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('[PayPal] Backend init error:', response.status, text.slice(0, 300));
          throw new Error(`Order creation failed (HTTP ${response.status})`);
        }

        const orderData = await response.json();

        if (orderData.id) {
          return orderData.id;
        }

        const errorDetail = orderData?.details?.[0];
        throw new Error(
          errorDetail
            ? `${errorDetail.issue} ${errorDetail.description} (${orderData.debug_id})`
            : JSON.stringify(orderData)
        );
      },

      onApprove: async (data: any) => {
        const response = await fetch(`${API_URL}/public/checkout/capture`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderID: data.orderID, clientDetails })
        });

        const contentType = response.headers.get('content-type') ?? '';
        if (!response.ok || !contentType.includes('application/json')) {
          const text = await response.text();
          console.error('[PayPal] Backend capture error:', response.status, text.slice(0, 300));
          throw new Error(`Capture failed (HTTP ${response.status})`);
        }

        const transaction = await response.json();

        if (transaction.status === 'SUCCESS' || transaction.status === 'COMPLETED') {
          onApprove(transaction);
        } else {
          const errorDetail = transaction?.details?.[0];
          throw new Error(
            errorDetail
              ? `${errorDetail.issue} ${errorDetail.description} (${transaction.debug_id})`
              : JSON.stringify(transaction)
          );
        }
      },

      onError: (err: any) => {
        console.error('[PayPal] SDK error:', err);
        onError(err);
      }

    }).render('#paypal-button-container');
  });

  window.addEventListener('reset-paypal', () => {
    const wrapper   = document.getElementById('paypal-container-wrapper');
    const container = document.getElementById('paypal-button-container');
    if (wrapper)    wrapper.classList.add('hidden');
    if (container)  container.innerHTML = '<div class="text-center text-white/50 text-sm animate-pulse">Initializing PayPal...</div>';
  });
</script>