---

---
<div id="paypal-container-wrapper" class="hidden space-y-4">
  <div id="paypal-button-container" class="pt-4 min-h-37.5">
    <!-- PayPal Buttons will be rendered here -->
    <div class="text-center text-white/50 text-sm animate-pulse">Initializing PayPal...</div>
  </div>
  <p class="text-xs text-white/40 text-center">
    Secure payment processed by PayPal. All transactions are encrypted.
  </p>
</div>

<script is:inline src="https://www.paypal.com/sdk/js?client-id=sb&currency=USD"></script>

<script>
  // This script will be handled by the parent component or via custom events
  window.addEventListener('init-paypal', (e: any) => {
    const { programId, adults, children, customAmount, clientDetails, onApprove, onError } = e.detail;
    const wrapper = document.getElementById('paypal-container-wrapper');
    const container = document.getElementById('paypal-button-container');
    
    if (!wrapper || !container) return;
    
    wrapper.classList.remove('hidden');
    container.innerHTML = ''; // Clear previous

    const API_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:3000/api';

    // @ts-ignore
    if (window.paypal) {
      // @ts-ignore
      window.paypal.Buttons({
        createOrder: async () => {
            try {
                const response = await fetch(`${API_URL}/public/checkout/init`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        programId,
                        adults,
                        children,
                        customAmount
                    })
                });
                
                const orderData = await response.json();

                if (orderData.id) {
                    return orderData.id;
                } else {
                    const errorDetail = orderData?.details?.[0];
                    const errorMessage = errorDetail? `${errorDetail.issue} ${errorDetail.description} (${orderData.debug_id})` : JSON.stringify(orderData);
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error(error);
                // onError(error); // Let PayPal handle generic error or call custom
                throw error; // Rethrow to stop flow
            }
        },
        onApprove: async (data, actions) => {
            try {
                const response = await fetch(`${API_URL}/public/checkout/capture`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        orderID: data.orderID,
                        clientDetails: clientDetails // Pass client info for user creation
                    })
                });

                const transaction = await response.json();
                
                if (transaction.status === 'SUCCESS' || transaction.status === 'COMPLETED') {
                    onApprove(transaction);
                } else {
                     const errorDetail = transaction?.details?.[0];
                    const errorMessage = errorDetail? `${errorDetail.issue} ${errorDetail.description} (${transaction.debug_id})` : JSON.stringify(transaction);
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error(error);
                onError(error);
            }
        },
        onError: onError
      }).render('#paypal-button-container');
    }
  });

  window.addEventListener('reset-paypal', () => {
    const wrapper = document.getElementById('paypal-container-wrapper');
    const container = document.getElementById('paypal-button-container');
    if (wrapper) wrapper.classList.add('hidden');
    if (container) container.innerHTML = '<div class="text-center text-white/50 text-sm animate-pulse">Initializing PayPal...</div>';
  });
</script>
